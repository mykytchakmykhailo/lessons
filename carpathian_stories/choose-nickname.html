<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢—ñ–Ω—ñ –ü–∞—Ä–∫—É ‚Äî –°—Ç–≤–æ—Ä–∏ —Å–≤—ñ–π –æ–±—Ä–∞–∑</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css">
  <style>
    .profile-setup {
      background: rgba(20, 20, 40, 0.7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(184, 151, 94, 0.2);
      border-radius: 16px;
      padding: 2rem;
      max-width: 460px;
      margin: 0 auto;
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 1.2rem;
      margin: 1.5rem 0;
    }

    .avatar-option {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.25s ease;
      background: #111;
      position: relative;
    }

    .avatar-option:hover,
    .avatar-option.selected {
      border-color: #b8975e;
      transform: scale(1.12);
      box-shadow: 0 0 20px rgba(184, 151, 94, 0.4);
    }

    .avatar-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upload-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2a1a47, #1a0f2e);
      color: #777;
      font-size: 2.5rem;
      transition: all 0.3s;
    }

    .upload-placeholder:hover {
      color: #b8975e;
    }

    #nickname {
      width: 100%;
      padding: 14px;
      font-size: 1.2rem;
      margin: 1rem 0 0.5rem;
      border-radius: 10px;
      border: 2px solid #444;
      background: rgba(30,30,50,0.7);
      color: white;
    }

    #nickname:focus {
      outline: none;
      border-color: #b8975e;
    }

    .status {
      min-height: 1.4em;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .error { color: #ff6b6b; }
    .success { color: #51cf66; }

    .save-btn {
      background: linear-gradient(135deg, #6a48ff, #b8975e);
      color: white;
      padding: 1rem 2.5rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 1.5rem;
    }

    .save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="bg"></div>

<div class="content">
  <h1>–°—Ç–≤–æ—Ä–∏ —Å–≤—ñ–π –æ–±—Ä–∞–∑</h1>
  <p class="hint">–û–±–µ—Ä–∏ —ñ–º'—è —Ç–∞ –≤—Ç—ñ–ª–µ–Ω–Ω—è –¥–ª—è —Å–≤—ñ—Ç—É –¢—ñ–Ω–µ–π</p>

  <div class="profile-setup">
    <input type="text" id="nickname" placeholder="–¢–≤—ñ–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –Ω—ñ–∫..." maxlength="20" autocomplete="off"/>
    <div id="status" class="status"></div>

    <div class="avatar-grid">
      <!-- –ì–æ—Ç–æ–≤—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∞–≤–∞—Ç–∞—Ä–æ–∫ (–º–æ–∂–µ—à –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —Å–≤–æ—ó –∑ Firebase Storage) -->
      <div class="avatar-option" data-url="https://thumbs.dreamstime.com/b/dark-silhouette-werewolf-howling-cliff-under-glowing-full-moon-tattered-fur-sharp-claws-outlined-pale-light-392677175.jpg">
        <img src="https://thumbs.dreamstime.com/b/dark-silhouette-werewolf-howling-cliff-under-glowing-full-moon-tattered-fur-sharp-claws-outlined-pale-light-392677175.jpg" alt="–í–æ–≤–∫—É–ª–∞–∫">
      </div>

      <div class="avatar-option" data-url="https://thumbs.dreamstime.com/b/fierce-werewolf-howling-under-full-moon-dark-forest-fierce-werewolf-howling-bared-teeth-under-full-moon-surrounded-397236983.jpg">
        <img src="https://thumbs.dreamstime.com/b/fierce-werewolf-howling-under-full-moon-dark-forest-fierce-werewolf-howling-bared-teeth-under-full-moon-surrounded-397236983.jpg" alt="–í–æ–≤–∫—É–ª–∞–∫ —É –ª—ñ—Å—ñ">
      </div>

      <div class="avatar-option" data-url="https://thumbs.dreamstime.com/b/large-tree-stands-mystical-forest-its-branches-stretching-wide-above-roots-entangled-green-moss-creating-vibrant-274802957.jpg">
        <img src="https://thumbs.dreamstime.com/b/large-tree-stands-mystical-forest-its-branches-stretching-wide-above-roots-entangled-green-moss-creating-vibrant-274802957.jpg" alt="–î—É—Ö –¥–µ—Ä–µ–≤–∞">
      </div>

      <div class="avatar-option" data-url="https://thumbs.dreamstime.com/b/mysterious-hooded-figure-misty-forest-dark-fantasy-atmosphere-hooded-figure-stands-misty-forest-creating-dark-eerie-357268473.jpg">
        <img src="https://thumbs.dreamstime.com/b/mysterious-hooded-figure-misty-forest-dark-fantasy-atmosphere-hooded-figure-stands-misty-forest-creating-dark-eerie-357268473.jpg" alt="–¢–∞—î–º–Ω–∏—á–∞ –ø–æ—Å—Ç–∞—Ç—å">
      </div>

      <!-- –°–ª–æ—Ç –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–≤–æ—î—ó –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
      <div class="avatar-option upload-option" data-url="">
        <div class="upload-placeholder">+</div>
        <input type="file" id="custom-avatar" accept="image/*" hidden>
      </div>
    </div>

    <button id="save-profile" class="save-btn" disabled>–í—Å—Ç—É–ø–∏—Ç–∏ –≤ –≥—Ä—É</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEToRTAs4z8SLW8DIiFMzZYWTZOHfmvhs",
  authDomain: "carpathianstories-b826c.firebaseapp.com",
  projectId: "carpathianstories-b826c",
  storageBucket: "carpathianstories-b826c.firebasestorage.app",
  messagingSenderId: "70281321648",
  appId: "1:70281321648:web:27f819a8453cbf615e6f75"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const nicknameInput = document.getElementById('nickname');
const statusDiv = document.getElementById('status');
const saveBtn = document.getElementById('save-profile');
const avatarOptions = document.querySelectorAll('.avatar-option:not(.upload-option)');
const fileInput = document.getElementById('custom-avatar');
const uploadSlot = document.querySelector('.upload-option');

let selectedAvatarUrl = null;
let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = 'index.html';
    return;
  }
  currentUser = user;
});

// –í–∏–±—ñ—Ä –≥–æ—Ç–æ–≤–æ—ó –∞–≤–∞—Ç–∞—Ä–∫–∏
avatarOptions.forEach(option => {
  option.addEventListener('click', () => {
    avatarOptions.forEach(o => o.classList.remove('selected'));
    uploadSlot.classList.remove('selected');
    option.classList.add('selected');
    selectedAvatarUrl = option.dataset.url;
    checkCanSave();
  });
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—ó –∞–≤–∞—Ç–∞—Ä–∫–∏
uploadSlot.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const storageRef = ref(storage, `avatars/${currentUser.uid}_${Date.now()}.jpg`);
    await uploadBytes(storageRef, file);
    selectedAvatarUrl = await getDownloadURL(storageRef);

    uploadSlot.innerHTML = `<img src="${selectedAvatarUrl}" alt="–ú–æ—è –∞–≤–∞—Ç–∞—Ä–∫–∞">`;
    uploadSlot.classList.add('selected');
    avatarOptions.forEach(o => o.classList.remove('selected'));

    checkCanSave();
  } catch (err) {
    statusDiv.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
    statusDiv.className = 'status error';
  }
});

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –Ω—ñ–∫—É (–≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ)
let checkTimer;
nicknameInput.addEventListener('input', () => {
  clearTimeout(checkTimer);
  saveBtn.disabled = true;
  statusDiv.textContent = '';

  const nick = nicknameInput.value.trim();
  if (nick.length < 3) {
    statusDiv.textContent = '–ú—ñ–Ω—ñ–º—É–º 3 —Å–∏–º–≤–æ–ª–∏';
    statusDiv.className = 'status error';
    return;
  }

  checkTimer = setTimeout(async () => {
    statusDiv.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ...';
    statusDiv.className = 'status';

    const lowerNick = nick.toLowerCase();
    const nickRef = doc(db, "usernames", lowerNick);
    const exists = (await getDoc(nickRef)).exists();

    if (exists) {
      statusDiv.textContent = '–¢–∞–∫–∏–π –Ω—ñ–∫ –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π üòî';
      statusDiv.className = 'status error';
    } else {
      statusDiv.textContent = '–ù—ñ–∫ –≤—ñ–ª—å–Ω–∏–π ‚úì';
      statusDiv.className = 'status success';
      checkCanSave();
    }
  }, 600);
});

function checkCanSave() {
  const nick = nicknameInput.value.trim();
  const isNickOk = nick.length >= 3 && statusDiv.className.includes('success');
  saveBtn.disabled = !(isNickOk && selectedAvatarUrl);
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
saveBtn.addEventListener('click', async () => {
  const nick = nicknameInput.value.trim();
  if (!nick || !selectedAvatarUrl || saveBtn.disabled) return;

  saveBtn.disabled = true;
  statusDiv.textContent = '–ó–±–µ—Ä—ñ–≥–∞—î–º–æ...';

  try {
    const lowerNick = nick.toLowerCase();

    // –û–Ω–æ–≤–ª—é—î–º–æ/—Å—Ç–≤–æ—Ä—é—î–º–æ –¥–æ–∫—É–º–µ–Ω—Ç –≥—Ä–∞–≤—Ü—è
    await updateDoc(doc(db, "players", currentUser.uid), {
      username: nick,
      photo: selectedAvatarUrl
    });

    // –†–µ–∑–µ—Ä–≤—É—î–º–æ –Ω—ñ–∫ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
    await setDoc(doc(db, "usernames", lowerNick), {
      uid: currentUser.uid,
      createdAt: new Date()
    });

    window.location.href = 'main.html';
  } catch (error) {
    statusDiv.textContent = '–ü–æ–º–∏–ª–∫–∞: ' + error.message;
    statusDiv.className = 'status error';
    saveBtn.disabled = false;
  }
});
</script>
</body>
</html>